<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.inogard.enio.agent.mappers.item.ItemDumMapper">
  <sql id="sqlSelect">
    SELECT  COUNT(*) OVER () filtered_count, 
            di.erp_item_cd, 
            di.item_nm, 
            di.size_nm, 
            di.model_nm, 
            di.unit_cd, 
            di.mk_comp_nm, 
            dbo.getStringToDateTime(di.reg_dt) AS reg_dt, 
            di.use_yn, 
            di.cls_cd, 
            dbo.getStringToDateTime(di.e4u_if_dt) AS e4u_if_dt, 
            di.e4u_if_st, 
            di.e4u_item_cd 
    FROM   agt_dum_item di 
  </sql>

  <select id="findByErpItemCd" parameterType="string" resultType="itemDum">
    <include refid="sqlSelect"/>
    <![CDATA[
      WHERE  di.erp_item_cd = #{value}
    ]]>
  </select>

  <select id="findAllNotSend" resultType="itemDum">
    <include refid="sqlSelect"/>
    <![CDATA[
      WHERE  di.e4u_item_cd IS NULL
      AND di.e4u_if_st = 'SR'
    ]]>
  </select>

  <select id="findAll" resultType="itemDum">
    SELECT Z.*
    FROM (
      SELECT ROW_NUMBER() OVER(
                                                      <choose>
                                                        <when test="pageable != null and pageable.sort != null">
                                                          <foreach item="order" collection="pageable.sort" open="ORDER BY " separator=",">
                                                            ${order.property} ${order.direction}
                                                          </foreach>
                                                        </when>
                                                        <otherwise>
                                                          ORDER BY reg_dt DESC
                                                        </otherwise>
                                                      </choose>
                                                    ) AS RNUM
               ,  X.*
      FROM (
        <include refid="sqlSelect"/>
        <where>
          <if test="search != null">
            <if test="search.value != null and search.value != ''">
            <![CDATA[
            (
              di.erp_item_cd like '%'||#{search.value}||'%'
              or di.item_nm like '%'||#{search.value}||'%'
              or di.size_nm like '%'||#{search.value}||'%'
              or di.model_nm like '%'||#{search.value}||'%'
              or di.unit_cd like '%'||#{search.value}||'%'
              or di.mk_comp_nm like '%'||#{search.value}||'%'
              or di.e4u_item_cd like '%'||#{search.value}||'%'
            )
            ]]>
            </if>
            <if test="search.e4uIfSt != null and search.e4uIfSt != ''">
            <![CDATA[
              AND di.e4u_if_st = #{search.e4uIfSt}
            ]]>
            </if>
          </if>
        </where>
      ) X
    ) Z
    <if test="pageable != null">
    <![CDATA[
      	WHERE Z.RNUM BETWEEN ( #{pageable.page} * #{pageable.size} + 1 ) AND ( (#{pageable.page} + 1) * #{pageable.size} )  
    ]]>
    </if>
  </select>

  <select id="count" resultType="long">
  <![CDATA[
    SELECT count(*)
    FROM agt_dum_item
  ]]>
  </select>

  <insert id="add" parameterType="itemDum">
  <![CDATA[
    INSERT INTO agt_dum_item(
      erp_item_cd, 
      item_nm, 
      size_nm, 
      model_nm, 
      unit_cd, 
      mk_comp_nm, 
      reg_dt, 
      use_yn, 
      cls_cd, 
      e4u_if_dt, 
      e4u_item_cd
    ) VALUES (
      #{erpItemCd}, 
      #{itemNm}, 
      #{sizeNm}, 
      #{modelNm}, 
      #{unitCd}, 
      #{mkCompNm}, 
      CONVERT(CHAR(8), GETDATE(), 112) + REPLACE(CONVERT(CHAR(8), GETDATE(), 114), ':', ''), 
      #{useYn}, 
      #{clsCd}, 
      NULL, 
      NULL 
    )
  ]]>
  </insert>

  <update id="updateE4uItemCd" parameterType="itemDum">
  <![CDATA[
    UPDATE agt_dum_item 
		SET    e4u_if_dt = CONVERT(CHAR(8), GETDATE(), 112) + REPLACE(CONVERT(CHAR(8), GETDATE(), 114), ':', ''), 
		       e4u_item_cd = #{e4uItemCd} 
		WHERE  erp_item_cd = #{erpItemCd} 
  ]]>
  </update>

  <update id="updateE4uIfSt" parameterType="itemDum">
  <![CDATA[
    UPDATE agt_dum_item 
    SET    e4u_if_st = #{e4uIfSt}, 
           e4u_if_dt = CONVERT(CHAR(8), GETDATE(), 112) + REPLACE(CONVERT(CHAR(8), GETDATE(), 114), ':', '') 
    WHERE  erp_item_cd = #{erpItemCd} 
  ]]>
  </update>
</mapper>